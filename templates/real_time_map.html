<!-- templates/tracking/real_time_map.html -->
{% extends 'tracking/base.html' %}

{% block title %}Real-time Map - Parole Tracking System{% endblock %}

{% block content %}
<div class="row h-100">
    <!-- Map Container -->
    <div class="col-lg-9">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-map-marked-alt"></i> Real-time Tracking Map
                </h5>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-primary" onclick="toggleTrafficLayer()">
                        <i class="fas fa-road"></i> Traffic
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="fitMapToMarkers()">
                        <i class="fas fa-expand-arrows-alt"></i> Fit All
                    </button>
                    <button type="button" class="btn btn-outline-success" onclick="refreshMapData()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="real-time-map" class="map-container"></div>
            </div>
        </div>
    </div>
    
    <!-- Sidebar -->
    <div class="col-lg-3">
        <div class="sidebar">
            <!-- Live Alerts -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-exclamation-triangle text-danger"></i> Live Alerts
                        <span class="badge bg-danger ms-2" id="alert-count">0</span>
                    </h6>
                </div>
                <div class="card-body p-2" style="max-height: 300px; overflow-y: auto;">
                    <div id="live-alerts">
                        <div class="text-center">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Device Status -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-mobile-alt"></i> Device Status
                    </h6>
                </div>
                <div class="card-body p-2" style="max-height: 400px; overflow-y: auto;">
                    <div id="device-status">
                        <div class="text-center">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Map Legend -->
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-info-circle"></i> Map Legend
                    </h6>
                </div>
                <div class="card-body p-2">
                    <div class="row mb-2">
                        <div class="col-auto">
                            <img src="https://maps.google.com/mapfiles/ms/icons/green-dot.png" width="20" height="20">
                        </div>
                        <div class="col">
                            <small>Active Device</small>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-auto">
                            <img src="https://maps.google.com/mapfiles/ms/icons/orange-dot.png" width="20" height="20">
                        </div>
                        <div class="col">
                            <small>Low Battery</small>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-auto">
                            <img src="https://maps.google.com/mapfiles/ms/icons/red-dot.png" width="20" height="20">
                        </div>
                        <div class="col">
                            <small>Alert/Violation</small>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-auto">
                            <img src="https://maps.google.com/mapfiles/ms/icons/blue-dot.png" width="20" height="20">
                        </div>
                        <div class="col">
                            <small>Offline Device</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initRealTimeMap" async defer></script>
<script>
let realTimeMap;
let realTimeMarkers = [];
let trafficLayer;
let geofenceCircles = [];

function initRealTimeMap() {
    realTimeMap = new google.maps.Map(document.getElementById('real-time-map'), {
        zoom: 12,
        center: { lat: -1.2921, lng: 36.8219 }, // Default center
        mapTypeId: 'roadmap',
        streetViewControl: false,
        fullscreenControl: true
    });
    
    trafficLayer = new google.maps.TrafficLayer();
    
    loadRealTimeData();
    loadGeofences();
}

function loadRealTimeData() {
    fetch('/api/map-data/')
        .then(response => response.json())
        .then(data => {
            updateRealTimeMap(data);
            updateSidebar(data);
        })
        .catch(error => {
            console.error('Error loading real-time data:', error);
        });
}

function updateRealTimeMap(data) {
    // Clear existing markers
    realTimeMarkers.forEach(marker => marker.setMap(null));
    realTimeMarkers = [];
    
    const bounds = new google.maps.LatLngBounds();
    
    // Add location markers
    data.locations.forEach(location => {
        const position = { lat: location.latitude, lng: location.longitude };
        const marker = new google.maps.Marker({
            position: position,
            map: realTimeMap,
            title: location.inmate_name,
            icon: getMarkerIcon(location.status),
            animation: google.maps.Animation.DROP
        });
        
        const infoWindow = new google.maps.InfoWindow({
            content: createLocationInfoWindow(location)
        });
        
        marker.addListener('click', () => {
            infoWindow.open(realTimeMap, marker);
        });
        
        realTimeMarkers.push(marker);
        bounds.extend(position);
    });
    
    // Add alert markers
    data.alerts.forEach(alert => {
        const position = { lat: alert.latitude, lng: alert.longitude };
        const marker = new google.maps.Marker({
            position: position,
            map: realTimeMap,
            title: `Alert: ${alert.type}`,
            icon: getAlertMarkerIcon(alert.severity),
            animation: google.maps.Animation.BOUNCE
        });
        
        const infoWindow = new google.maps.InfoWindow({
            content: createAlertInfoWindow(alert)
        });
        
        marker.addListener('click', () => {
            infoWindow.open(realTimeMap, marker);
        });
        
        realTimeMarkers.push(marker);
        bounds.extend(position);
    });
    
    // Auto-fit map if there are markers
    if (realTimeMarkers.length > 0) {
        realTimeMap.fitBounds(bounds);
    }
}

function createLocationInfoWindow(location) {
    const batteryColor = getBatteryColor(location.battery_level);
    const statusColor = location.status === 'active' ? 'success' : 'danger';
    
    return `
        <div style="max-width: 250px;">
            <h6 class="mb-2">${location.inmate_name}</h6>
            <table class="table table-sm table-borderless mb-2">
                <tr>
                    <td><strong>Device ID:</strong></td>
                    <td>${location.device_id}</td>
                </tr>
                <tr>
                    <td><strong>Battery:</strong></td>
                    <td><span class="badge bg-${batteryColor}">${location.battery_level}%</span></td>
                </tr>
                <tr>
                    <td><strong>Status:</strong></td>
                    <td><span class="badge bg-${statusColor}">${location.status}</span></td>
                </tr>
                <tr>
                    <td><strong>Last Update:</strong></td>
                    <td>${new Date(location.last_update).toLocaleString()}</td>
                </tr>
            </table>
            <div class="text-center">
                <button class="btn btn-sm btn-primary" onclick="centerMapOnLocation(${location.latitude}, ${location.longitude})">
                    <i class="fas fa-crosshairs"></i> Center
                </button>
            </div>
        </div>
    `;
}

function createAlertInfoWindow(alert) {
    const severityColor = getSeverityColor(alert.severity);
    
    return `
        <div style="max-width: 300px;">
            <h6 class="text-danger mb-2">
                <i class="fas fa-exclamation-triangle"></i> ALERT: ${alert.type.toUpperCase()}
            </h6>
            <table class="table table-sm table-borderless mb-2">
                <tr>
                    <td><strong>Inmate:</strong></td>
                    <td>${alert.inmate_name}</td>
                </tr>
                <tr>
                    <td><strong>Severity:</strong></td>
                    <td><span class="badge bg-${severityColor}">${alert.severity}</span></td>
                </tr>
                <tr>
                    <td><strong>Time:</strong></td>
                    <td>${new Date(alert.created_at).toLocaleString()}</td>
                </tr>
            </table>
            <p><strong>Description:</strong><br>${alert.description}</p>
            <div class="text-center">
                <button class="btn btn-sm btn-danger" onclick="acknowledgeAlert('${alert.id}')">
                    <i class="fas fa-check"></i> Acknowledge
                </button>
            </div>
        </div>
    `;
}

function updateSidebar(data) {
    updateLiveAlerts(data.alerts);
    updateDeviceStatus(data.locations);
}

function updateLiveAlerts(alerts) {
    const alertsContainer = document.getElementById('live-alerts');
    const alertCount = document.getElementById('alert-count');
    
    alertCount.textContent = alerts.length;
    
    if (alerts.length > 0) {
        alertsContainer.innerHTML = alerts.map(alert => `
            <div class="alert-item alert-${alert.severity} p-2 mb-2 bg-light rounded border">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h6 class="mb-1 text-${getSeverityColor(alert.severity)}" style="font-size: 0.85rem;">
                            ${alert.type.replace('_', ' ').toUpperCase()}
                        </h6>
                        <p class="mb-1" style="font-size: 0.75rem;">${alert.inmate_name}</p>
                        <small class="text-muted" style="font-size: 0.7rem;">
                            ${new Date(alert.created_at).toLocaleString()}
                        </small>
                    </div>
                    <button class="btn btn-sm btn-outline-primary" 
                            onclick="centerMapOnAlert(${alert.latitude}, ${alert.longitude})"
                            style="font-size: 0.7rem;">
                        <i class="fas fa-map-marker-alt"></i>
                    </button>
                </div>
            </div>
        `).join('');
    } else {
        alertsContainer.innerHTML = '<p class="text-muted text-center small">No active alerts</p>';
    }
}

function updateDeviceStatus(locations) {
    const statusContainer = document.getElementById('device-status');
    
    if (locations.length > 0) {
        statusContainer.innerHTML = locations.map(location => `
            <div class="d-flex justify-content-between align-items-center p-2 mb-2 bg-light rounded border">
                <div class="flex-grow-1">
                    <h6 class="mb-1" style="font-size: 0.85rem;">${location.inmate_name}</h6>
                    <p class="mb-0 text-muted" style="font-size: 0.75rem;">ID: ${location.device_id}</p>
                    <small class="text-muted" style="font-size: 0.7rem;">
                        ${new Date(location.last_update).toLocaleString()}
                    </small>
                </div>
                <div class="text-end">
                    <div class="mb-1">
                        <span class="badge bg-${getBatteryColor(location.battery_level)}" style="font-size: 0.7rem;">
                            ${location.battery_level}%
                        </span>
                    </div>
                    <div>
                        <i class="fas fa-circle text-${location.status === 'active' ? 'success' : 'danger'}" 
                           style="font-size: 0.6rem;"></i>
                        <span style="font-size: 0.7rem;">${location.status}</span>
                    </div>
                </div>
            </div>
        `).join('');
    } else {
        statusContainer.innerHTML = '<p class="text-muted text-center small">No active devices</p>';
    }
}

function toggleTrafficLayer() {
    if (trafficLayer.getMap()) {
        trafficLayer.setMap(null);
    } else {
        trafficLayer.setMap(realTimeMap);
    }
}

function fitMapToMarkers() {
    if (realTimeMarkers.length > 0) {
        const bounds = new google.maps.LatLngBounds();
        realTimeMarkers.forEach